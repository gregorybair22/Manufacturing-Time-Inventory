@page
@model ManufacturingTimeTracking.Pages.Orders.SummaryModel
@{
    ViewData["Title"] = "Order Summary";
}

<div class="animate-fade-in">
    <div class="flex flex-wrap gap-3 mb-6">
        <a asp-page="./Index" class="px-5 py-2.5 rounded-xl border border-slate-300 text-slate-700 font-medium hover:bg-slate-50 transition-all duration-200">Back to Orders</a>
        @if (Model.LatestExecution != null)
        {
            <a asp-page="./Summary" asp-page-handler="ExportCsv" asp-route-id="@Model.BuildOrder.Id" class="px-5 py-2.5 rounded-xl bg-blue-600 text-white font-medium hover:bg-blue-700 shadow-md transition-all duration-200">Export CSV</a>
        }
    </div>

    <div class="bg-white rounded-2xl shadow-soft border border-slate-100 p-6 mb-6">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">Order Information</h2>
        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div><dt class="text-sm font-medium text-slate-500">External Ref</dt><dd class="font-medium text-slate-800">@Model.BuildOrder.ExternalRef</dd></div>
            <div><dt class="text-sm font-medium text-slate-500">Serial Number</dt><dd class="font-medium text-slate-800">@Model.BuildOrder.SerialNumber</dd></div>
            <div><dt class="text-sm font-medium text-slate-500">Status</dt><dd><span class="inline-flex px-2.5 py-1 rounded-full text-xs font-medium @(Model.BuildOrder.Status == "Completed" ? "bg-emerald-100 text-emerald-800" : Model.BuildOrder.Status == "InProgress" ? "bg-amber-100 text-amber-800" : "bg-slate-100 text-slate-700")">@Model.BuildOrder.Status</span></dd></div>
            <div><dt class="text-sm font-medium text-slate-500">Created</dt><dd class="font-medium text-slate-800">@Model.BuildOrder.CreatedAt.ToString("g")</dd></div>
        </dl>
    </div>

    @if (Model.LatestExecution != null)
    {
        <div class="bg-white rounded-2xl shadow-soft border border-slate-100 p-6 mb-6">
            <h2 class="text-lg font-semibold text-slate-800 mb-4">Execution Summary</h2>
            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div><dt class="text-sm font-medium text-slate-500">Started</dt><dd class="font-medium text-slate-800">@Model.LatestExecution.StartedAt.ToString("g")</dd></div>
                @if (Model.LatestExecution.FinishedAt.HasValue)
                {
                    <div><dt class="text-sm font-medium text-slate-500">Finished</dt><dd class="font-medium text-slate-800">@Model.LatestExecution.FinishedAt.Value.ToString("g")</dd></div>
                    <div><dt class="text-sm font-medium text-slate-500">Duration</dt><dd class="font-medium text-slate-800">@((Model.LatestExecution.FinishedAt.Value - Model.LatestExecution.StartedAt).ToString(@"d\d\ hh\:mm\:ss"))</dd></div>
                }
                <div><dt class="text-sm font-medium text-slate-500">Status</dt><dd><span class="inline-flex px-2.5 py-1 rounded-full text-xs font-medium @(Model.LatestExecution.Status == "Completed" ? "bg-emerald-100 text-emerald-800" : "bg-amber-100 text-amber-800")">@Model.LatestExecution.Status</span></dd></div>
            </dl>
        </div>

        @foreach (var phase in Model.LatestExecution.Phases.OrderBy(p => p.SortOrder))
        {
            <div class="bg-white rounded-2xl shadow-soft border border-slate-100 p-6 mb-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">@phase.Name</h3>
                <div class="overflow-x-auto rounded-xl border border-slate-100">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50/80">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500">#</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500">Step</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500">Skip Reason</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500">Total Time</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500">Runs</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500">Workstations</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            @foreach (var step in phase.Steps.OrderBy(s => s.SortOrder))
                            {
                                var totalSeconds = step.Runs.Where(r => r.DurationSeconds.HasValue).Sum(r => r.DurationSeconds.Value);
                                var timeSpan = TimeSpan.FromSeconds(totalSeconds);
                                var runs = step.Runs.Where(r => r.DurationSeconds.HasValue).Count();
                                var workstations = step.Runs.Where(r => r.Workstation != null).Select(r => r.Workstation!.Name).Distinct().ToList();
                                <tr class="table-row-hover">
                                    <td class="px-4 py-3 text-slate-600">@step.SortOrder</td>
                                    <td class="px-4 py-3">
                                        <span class="font-medium text-slate-800">@step.Title</span>
                                        @if (!string.IsNullOrEmpty(step.Instructions))
                                        {
                                            <br /><span class="text-slate-500 text-sm">@step.Instructions</span>
                                        }
                                    </td>
                                    <td class="px-4 py-3"><span class="inline-flex px-2 py-0.5 rounded text-xs font-medium @(step.State == "Done" ? "bg-emerald-100 text-emerald-800" : step.State == "Skipped" ? "bg-amber-100 text-amber-800" : step.State == "InProgress" ? "bg-blue-100 text-blue-800" : "bg-slate-100 text-slate-700")">@step.State</span></td>
                                    <td class="px-4 py-3 text-slate-600">@(step.SkipReason ?? "—")</td>
                                    <td class="px-4 py-3 text-slate-600">@(totalSeconds > 0 ? timeSpan.ToString(@"hh\:mm\:ss") : "—")</td>
                                    <td class="px-4 py-3 text-slate-600">@runs</td>
                                    <td class="px-4 py-3 text-slate-600">@(workstations.Any() ? string.Join(", ", workstations) : "—")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    }
    else
    {
        <div class="p-4 rounded-xl bg-slate-50 border border-slate-200 text-slate-700">No execution found for this order.</div>
    }
</div>
