@page
@model ManufacturingTimeTracking.Pages.Orders.DetailsModel
@{
    ViewData["Title"] = "Order Details";
}

<h1>Order Details</h1>

<div class="mb-3">
    <a asp-page="./Index" class="btn btn-secondary">Back to List</a>
    <a asp-page="./PickList" asp-route-id="@Model.BuildOrder.Id" class="btn btn-outline-primary">Pick list (components)</a>
    <a asp-page="./Execute" asp-route-id="@Model.BuildOrder.Id" class="btn btn-primary">Execute</a>
</div>

<div class="card mb-3">
    <div class="card-header">
        <h5>Order Information</h5>
    </div>
    <div class="card-body">
        <dl class="row">
            <dt class="col-sm-2">External Ref:</dt>
            <dd class="col-sm-10">@Model.BuildOrder.ExternalRef</dd>
            <dt class="col-sm-2">Serial Number:</dt>
            <dd class="col-sm-10">@Model.BuildOrder.SerialNumber</dd>
            <dt class="col-sm-2">Status:</dt>
            <dd class="col-sm-10">
                <span class="badge @(Model.BuildOrder.Status == "InProgress" ? "bg-warning" : Model.BuildOrder.Status == "Completed" ? "bg-success" : "bg-secondary")">
                    @Model.BuildOrder.Status
                </span>
            </dd>
            <dt class="col-sm-2">Created:</dt>
            <dd class="col-sm-10">@Model.BuildOrder.CreatedAt.ToString("g")</dd>
        </dl>
    </div>
</div>

@if (Model.BuildOrder.Executions.Any())
{
    @foreach (var execution in Model.BuildOrder.Executions.OrderByDescending(e => e.StartedAt))
    {
        <div class="card mb-3">
            <div class="card-header">
                <h5>Execution - Started: @execution.StartedAt.ToString("g")</h5>
            </div>
            <div class="card-body">
                @foreach (var phase in execution.Phases.OrderBy(p => p.SortOrder))
                {
                    <h6>@phase.Name</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Step</th>
                                <th>Status</th>
                                <th>Total Time</th>
                                <th>Runs</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var step in phase.Steps.OrderBy(s => s.SortOrder))
                            {
                                var totalSeconds = step.Runs.Where(r => r.DurationSeconds.HasValue).Sum(r => r.DurationSeconds.Value);
                                var timeSpan = TimeSpan.FromSeconds(totalSeconds);
                                <tr>
                                    <td>@step.Title</td>
                                    <td>@step.State</td>
                                    <td>@(totalSeconds > 0 ? timeSpan.ToString(@"hh\:mm\:ss") : "-")</td>
                                    <td>@step.Runs.Count</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    }
}
